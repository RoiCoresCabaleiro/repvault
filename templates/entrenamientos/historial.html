{% extends "layout.html" %}

{% block content %}

<h2>Historial de entrenamientos</h2>

<div style="display: flex; justify-content: space-between; gap: 40px;">
    <!-- üü© COLUMNA IZQUIERDA: Historial agrupado -->
    <div style="flex: 2;">
        {% if historial %}
            {% for fecha, entrenamientos in historial.items() %}
                <h3 id="{{ fecha }}">{{ fecha }}</h3>
                {% for ent in entrenamientos %}
                    <div style="margin-left: 20px; margin-bottom: 20px;">
                        <strong>{{ ent.nombre }}</strong> -
                        <em>
                        {% if ent.fecha and ent.duracion is not none %}
                            {{ ent.fecha.split(" ")[1][:5] }} ({{ ent.duracion // 60 ~ 'h ' if ent.duracion >= 60 else '' }}{{ ent.duracion % 60 }}m)
                        {% endif %}
                        </em><br>
                        {% if ent.observaciones %}
                            <em>{{ ent.observaciones }}</em><br>
                        {% endif %}
                        <ul>
                        {% for clave, datos in ent.ejercicios.items() %}
                            {% if datos is mapping %}
                                <!-- Ejercicio eliminado con nombre persistente -->
                                <li>
                                    <strong>{{ datos.nombre }} (eliminado)</strong>
                                    <ul>
                                    {% for s in datos.series %}
                                        <li>{{ s.peso }} kg x {{ s.reps }} reps</li>
                                    {% endfor %}
                                    </ul>
                                </li>
                            {% else %}
                                <!-- Ejercicio a√∫n activo -->
                                <li>
                                    <strong>{{ ejercicios_nombres.get(clave, 'Ejercicio desconocido') }}</strong>
                                    <ul>
                                    {% for s in datos %}
                                        <li>{{ s.peso }} kg x {{ s.reps }} reps</li>
                                    {% endfor %}
                                    </ul>
                                </li>
                            {% endif %}
                        {% endfor %}
                        </ul>
                    </div>
                {% endfor %}
            {% endfor %}
        {% else %}
            <p>No hay entrenamientos guardados todav√≠a.</p>
        {% endif %}
    </div>

    <!-- üü¶ COLUMNA DERECHA: Calendario -->
    <div style="flex: 2.5; max-width: 500px; margin-right: 40px; position: sticky; top: 100px; align-self: flex-start; padding: 10px; border: 2px solid #ccc; background: white;">
        <h4 style="position: sticky; top: 0; background: white; display: flex; align-items: center; justify-content: space-between;">
            
            <a href="{{ url_for('entrenamientos.historial', mes=mes-1 if mes > 1 else 12, a√±o=a√±o if mes > 1 else a√±o-1) }}"
               style="text-decoration: none; font-size: 1.2em; padding: 0 10px;"
               onclick="sessionStorage.setItem('scrollPos', window.scrollY)">‚óÄ</a>
            
            <span style="flex-grow: 1; text-align: center;">{{ mes_nombre }} {{ a√±o }}</span>
            
            <a href="{{ url_for('entrenamientos.historial', mes=mes+1 if mes < 12 else 1, a√±o=a√±o if mes < 12 else a√±o+1) }}"
               style="text-decoration: none; font-size: 1.2em; padding: 0 10px;"
               onclick="sessionStorage.setItem('scrollPos', window.scrollY)">‚ñ∂</a>
        </h4>

        <table style="width: 100%; border-collapse: collapse; text-align: center;">
            <thead>
                <tr>
                    {% for letra in ["L", "M", "X", "J", "V", "S", "D"] %}
                        <th style="padding: 4px;">{{ letra }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for semana in calendario_filas %}
                    <tr>
                        {% for dia in semana %}
                            {% if dia %}
                                {% if dia.activo %}
                                    <td>
                                        <a href="#{{ "%02d/%02d/%d" % (dia.numero, mes, a√±o) }}"
                                           style="display: inline-block; width: 28px; height: 28px;
                                                  border-radius: 50%; background-color: lightgreen;
                                                  line-height: 28px; text-decoration: none; color: black;">
                                            {{ dia.numero }}
                                        </a>
                                    </td>
                                {% else %}
                                    <td>
                                        <div style="display: inline-block; width: 28px; height: 28px;
                                                    color: #aaa; line-height: 28px;">
                                            {{ dia.numero }}
                                        </div>
                                    </td>
                                {% endif %}
                            {% else %}
                                <td></td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
